<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Mis adopciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link th:href="@{/css/adopcion-flujo.css}" rel="stylesheet"/>
    <link th:href="@{/css/mis-adopciones.css}" rel="stylesheet"/>
</head>
<body class="page-shell">
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container py-4">
    <div class="section-card p-4">
        <div class="d-flex flex-wrap gap-2 mb-3">
            <a href="javascript:history.back()" class="btn btn-sm lp-btn lp-btn-outline">← Volver</a>
            <a th:href="@{/mascotas}" class="btn btn-sm lp-btn lp-btn-outline">Ver catálogo</a>
        </div>

        <h1 class="h4 mb-1">Mis solicitudes de adopción</h1>
        <p class="text-muted mb-4">Vista moderna con filtros rápidos para revisar tus solicitudes activas y adopciones.</p>

        <div class="misadop-toolbar mb-4">
            <input id="filtroTexto" type="search" class="form-control" placeholder="Buscar por mascota, estado o tipo...">
            <select id="filtroTipo" class="form-select">
                <option value="TODOS">Todos</option>
                <option value="Solicitud">Solicitudes</option>
                <option value="Adopción">Adopciones</option>
            </select>
        </div>

        <div id="misadopGrid" class="misadop-grid">
            <article class="misadop-card p-3"
                     th:each="s : ${solicitudes}"
                     th:attr="data-tipo='Solicitud',data-mascota=${s.mascota != null ? s.mascota.nombre : ''},data-estado=${s.estado != null ? s.estado.id : ''}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge text-bg-secondary">Solicitud</span>
                    <small class="text-muted">#<span th:text="${s.id}">1</span></small>
                </div>

                <h2 class="h6 mb-1" th:text="${s.mascota != null ? s.mascota.nombre : '-'}">Mascota</h2>
                <p class="text-muted small mb-3" th:text="${s.fechaSolicitud != null ? #temporals.format(s.fechaSolicitud, 'dd/MM/yyyy HH:mm') : '-'}">-</p>

                <div class="misadop-meta mb-3">
                    <div>
                        <div class="small text-muted">Estado</div>
                        <span class="badge"
                              th:classappend="${s.estado != null and s.estado.id == 'PENDIENTE'} ? ' text-bg-warning' : (${s.estado != null and s.estado.id == 'APROBADA'} ? ' text-bg-success' : (${s.estado != null and s.estado.id == 'RECHAZADA'} ? ' text-bg-danger' : ' text-bg-secondary'))"
                              th:text="${s.estado != null ? s.estado.id : '-'}"></span>
                    </div>
                    <div>
                        <div class="small text-muted">Tipo</div>
                        <div class="fw-semibold">Solicitud</div>
                    </div>
                </div>

                <a class="btn btn-sm lp-btn lp-btn-outline"
                   th:href="@{'/adopcion/mis-adopciones/solicitud/' + ${s.id}}">
                    Ver detalle
                </a>
            </article>

            <article class="misadop-card p-3"
                     th:each="a : ${adopciones}"
                     th:attr="data-tipo='Adopción',data-mascota=${a.mascota != null ? a.mascota.nombre : ''},data-estado=${a.estado != null ? a.estado.id : ''}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge text-bg-primary">Adopción</span>
                    <small class="text-muted">#<span th:text="${a.id}">2</span></small>
                </div>

                <h2 class="h6 mb-1" th:text="${a.mascota != null ? a.mascota.nombre : '-'}">Mascota</h2>
                <p class="text-muted small mb-3" th:text="${a.fechaAdopcion != null ? #temporals.format(a.fechaAdopcion, 'dd/MM/yyyy HH:mm') : '-'}">-</p>

                <div class="misadop-meta mb-3">
                    <div>
                        <div class="small text-muted">Estado</div>
                        <span class="badge text-bg-success" th:text="${a.estado != null ? a.estado.id : '-'}"></span>
                    </div>
                    <div>
                        <div class="small text-muted">Tipo</div>
                        <div class="fw-semibold">Adopción</div>
                    </div>
                </div>

                <a class="btn btn-sm lp-btn lp-btn-outline" th:href="@{'/adopcion/seguimiento/' + ${a.id}}">
                    Ver detalle
                </a>
            </article>
        </div>

        <div id="misadopEmpty" class="misadop-empty mt-3 d-none">No hay resultados para el filtro actual.</div>
        <div class="misadop-empty mt-3" th:if="${#lists.isEmpty(solicitudes) and #lists.isEmpty(adopciones)}">
            No tienes registros de adopción todavía.
        </div>
    </div>
</div>

<div th:if="${param.created}">
<script>Swal.fire({icon:'success',title:'Solicitud enviada',text:'Tu solicitud de adopción fue registrada.'});</script>
</div>
<div th:if="${param.error == 'solicitud-activa'}">
<script>Swal.fire({icon:'warning',title:'Ya tienes una solicitud activa',text:'Solo puedes tener una solicitud PENDIENTE a la vez.'});</script>
</div>
<div th:if="${param.error == 'forbidden'}">
<script>Swal.fire({icon:'error',title:'Acceso denegado',text:'No tienes permiso para ver este detalle.'});</script>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
    const filtroTexto = document.getElementById('filtroTexto');
    const filtroTipo = document.getElementById('filtroTipo');
    const cards = Array.from(document.querySelectorAll('#misadopGrid .misadop-card'));
    const empty = document.getElementById('misadopEmpty');

    function normalizar(v) { return (v || '').toLowerCase().trim(); }

    function aplicarFiltros() {
        const q = normalizar(filtroTexto?.value);
        const tipo = filtroTipo?.value || 'TODOS';
        let visibles = 0;

        cards.forEach(card => {
            const tipoCard = card.dataset.tipo || '';
            const mascota = card.dataset.mascota || '';
            const estado = card.dataset.estado || '';
            const textMatch = !q || normalizar(`${tipoCard} ${mascota} ${estado}`).includes(q);
            const tipoMatch = tipo === 'TODOS' || tipo === tipoCard;
            const show = textMatch && tipoMatch;
            card.classList.toggle('d-none', !show);
            if (show) visibles++;
        });

        empty?.classList.toggle('d-none', visibles > 0);
    }

    filtroTexto?.addEventListener('input', aplicarFiltros);
    filtroTipo?.addEventListener('change', aplicarFiltros);
    aplicarFiltros();
})();
</script>
</body>
</html>
