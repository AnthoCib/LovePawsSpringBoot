<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Solicitudes por mascota</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link th:href="@{/css/admin.css}" rel="stylesheet">
    <link th:href="@{/css/adopcion-solicitudes.css}" rel="stylesheet"/>
</head>
<body class="admin-dark">
<div th:replace="~{fragments/gestor-navbar :: gestorNavbar}"></div>

<div class="container py-4">
    <h2 class="fw-bold mb-3">
        <i class="bi bi-journal-check me-2"></i>
        <span th:text="${vistaGlobal} ? 'Gestión de solicitudes de adopción' : 'Solicitudes de adopción por mascota'">Gestión de solicitudes de adopción</span>
    </h2>

    <p th:if="${mascota != null}" class="mb-3">Mascota: <strong th:text="${mascota.nombre}"></strong></p>

    <div class="card section-card shadow-sm">
        <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center gap-2">
            <span class="fw-semibold"><i class="bi bi-card-checklist me-2"></i>Listado de solicitudes</span>
            <div class="d-flex flex-wrap gap-2">
                <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left-short me-1"></i>Volver</a>
                <a th:href="@{/gestor/dashboard}" class="btn btn-sm btn-outline-primary"><i class="bi bi-speedometer2 me-1"></i>Dashboard gestor</a>
                <a th:href="@{/gestor/mascotas}" class="btn btn-sm btn-outline-primary"><i class="bi bi-heart-pulse me-1"></i>CRUD mascotas</a>
            </div>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Mascota</th>
                        <th>Adoptante</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="s : ${solicitudes}"
                        class="solicitud-row"
                        th:attr="data-id=${s.id},data-estado=${s.estado != null ? s.estado.id : '-'}"
                        th:classappend="${s.estado != null and s.estado.id == 'PENDIENTE'} ? ' estado-pendiente' : (${s.estado != null and s.estado.id == 'APROBADA'} ? ' estado-aprobada' : ' estado-rechazada')">
                        <td class="fw-semibold" th:text="${s.id}">1</td>
                        <td th:text="${s.mascota != null ? s.mascota.nombre : '-'}">Mascota</td>
                        <td th:text="${s.usuario != null ? s.usuario.nombre : '-'}">Adoptante</td>
                        <td class="motivo-col" th:text="${s.pqAdoptar != null ? s.pqAdoptar : '-'}">Motivo</td>
                        <td>
                            <span class="badge rounded-pill estado-badge"
                                  th:classappend="${s.estado != null and s.estado.id == 'PENDIENTE'} ? ' text-bg-warning' : (${s.estado != null and s.estado.id == 'APROBADA'} ? ' text-bg-success' : ' text-bg-danger')"
                                  th:text="${s.estado != null ? s.estado.id : '-'}">PENDIENTE</span>
                        </td>
                        <td class="text-end">
                            <div class="d-inline-flex gap-2" th:if="${s.estado != null and s.estado.id == 'PENDIENTE'}">
                                <button type="button"
                                        class="btn btn-outline-success btn-sm js-decidir"
                                        th:attr="data-id=${s.id},data-accion='APROBAR'">
                                    <i class="bi bi-check-circle me-1"></i>Aprobar
                                </button>
                                <button type="button"
                                        class="btn btn-outline-danger btn-sm js-decidir"
                                        th:attr="data-id=${s.id},data-accion='RECHAZAR'">
                                    <i class="bi bi-x-circle me-1"></i>Rechazar
                                </button>
                            </div>
                            <span class="text-muted small" th:if="${s.estado == null or s.estado.id != 'PENDIENTE'}">Sin acciones</span>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(solicitudes)}">
                        <td colspan="6" class="text-center text-muted">No hay solicitudes registradas.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    const token = document.querySelector('meta[name="_csrf"]')?.content;
    const headerName = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

    const estadoClasses = {
        PENDIENTE: { row: 'estado-pendiente', badge: 'text-bg-warning' },
        APROBADA: { row: 'estado-aprobada', badge: 'text-bg-success' },
        RECHAZADA: { row: 'estado-rechazada', badge: 'text-bg-danger' }
    };

    async function enviarDecision(id, accion, motivo) {
        const params = new URLSearchParams();
        params.append('accion', accion);
        if (motivo) params.append('motivo', motivo);

        const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
        if (token) headers[headerName] = token;

        const resp = await fetch(`/adopcion/gestor/solicitudes/${id}/decision`, {
            method: 'POST',
            headers,
            body: params.toString()
        });

        return resp.json();
    }

    function pintarEstado(row, nuevoEstado) {
        row.dataset.estado = nuevoEstado;
        row.classList.remove('estado-pendiente', 'estado-aprobada', 'estado-rechazada');

        const badge = row.querySelector('.estado-badge');
        badge.classList.remove('text-bg-warning', 'text-bg-success', 'text-bg-danger');

        const cfg = estadoClasses[nuevoEstado] || estadoClasses.RECHAZADA;
        row.classList.add(cfg.row);
        badge.classList.add(cfg.badge);
        badge.textContent = nuevoEstado;

        const actionBlock = row.querySelector('.js-decidir')?.closest('.d-inline-flex');
        if (actionBlock) {
            actionBlock.replaceWith(Object.assign(document.createElement('span'), {
                className: 'text-muted small',
                textContent: 'Sin acciones'
            }));
        }
    }

    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.js-decidir');
        if (!btn) return;

        const solicitudId = btn.dataset.id;
        const accion = btn.dataset.accion;

        let motivo = 'No cumple criterios de adopción';
        if (accion === 'RECHAZAR') {
            const { value: text, isConfirmed } = await Swal.fire({
                title: 'Rechazar solicitud',
                input: 'textarea',
                inputLabel: 'Motivo de rechazo',
                inputValue: motivo,
                showCancelButton: true,
                confirmButtonText: 'Sí, rechazar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => !value?.trim() ? 'El motivo es obligatorio' : undefined
            });
            if (!isConfirmed) return;
            motivo = text.trim();
        } else {
            const { isConfirmed } = await Swal.fire({
                icon: 'question',
                title: '¿Aprobar solicitud?',
                text: 'Se creará la adopción y la mascota quedará ADOPTADA.',
                showCancelButton: true,
                confirmButtonText: 'Sí, aprobar',
                cancelButtonText: 'Cancelar'
            });
            if (!isConfirmed) return;
            motivo = '';
        }

        try {
            const data = await enviarDecision(solicitudId, accion, motivo);
            if (!data.ok) {
                await Swal.fire({ icon: 'error', title: 'No se pudo actualizar', text: data.mensaje || 'Error inesperado' });
                return;
            }

            const row = document.querySelector(`.solicitud-row[data-id="${solicitudId}"]`);
            if (row) pintarEstado(row, data.estado);

            await Swal.fire({
                icon: accion === 'APROBAR' ? 'success' : 'info',
                title: accion === 'APROBAR' ? 'Solicitud aprobada' : 'Solicitud rechazada',
                text: data.mensaje || 'Operación realizada correctamente'
            });
        } catch (err) {
            await Swal.fire({ icon: 'error', title: 'Error de red', text: 'No se pudo completar la operación.' });
        }
    });
})();
</script>
</body>
</html>
