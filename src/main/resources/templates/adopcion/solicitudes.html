<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Solicitudes por mascota</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link th:href="@{/css/adopcion-flujo.css}" rel="stylesheet"/>
    <link th:href="@{/css/adopcion-solicitudes.css}" rel="stylesheet"/>
</head>
<body class="page-shell">
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container py-4">
    <div class="section-card p-4">
        <div class="d-flex flex-wrap gap-2 mb-3">
            <a href="javascript:history.back()" class="btn btn-sm lp-btn lp-btn-outline"><i class="bi bi-arrow-left-short me-1"></i>Volver</a>
            <a th:href="@{/gestor/dashboard}" class="btn btn-sm lp-btn lp-btn-outline"><i class="bi bi-speedometer2 me-1"></i>Dashboard gestor</a>
            <a th:href="@{/gestor/mascotas}" class="btn btn-sm lp-btn lp-btn-outline"><i class="bi bi-heart-pulse me-1"></i>CRUD mascotas</a>
        </div>

        <h1 class="h4" th:text="${vistaGlobal} ? 'Solicitudes de adopción (todas)' : 'Solicitudes de adopción por mascota'">Solicitudes de adopción</h1>
        <p th:if="${mascota != null}" class="mb-3">Mascota: <strong th:text="${mascota.nombre}"></strong></p>

        <div class="row g-3" id="solicitudesGrid">
            <div class="col-12 col-md-6 col-xl-4" th:each="s : ${solicitudes}">
                <article class="card h-100 solicitud-card"
                         th:attr="data-id=${s.id},data-estado=${s.estado != null ? s.estado.id : '-'}"
                         th:classappend="${s.estado != null and s.estado.id == 'PENDIENTE'} ? ' estado-pendiente' : (${s.estado != null and s.estado.id == 'APROBADA'} ? ' estado-aprobada' : ' estado-rechazada')">
                    <div class="card-body d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <h2 class="h6 mb-0">Solicitud <span th:text="${s.id}">#</span></h2>
                            <span class="badge rounded-pill fs-6 px-3 py-2 estado-badge"
                                  th:classappend="${s.estado != null and s.estado.id == 'PENDIENTE'} ? ' text-bg-warning' : (${s.estado != null and s.estado.id == 'APROBADA'} ? ' text-bg-success' : ' text-bg-danger')"
                                  th:text="${s.estado != null ? s.estado.id : '-'}">PENDIENTE</span>
                        </div>

                        <div class="small text-muted">Mascota</div>
                        <div class="fw-semibold" th:text="${s.mascota != null ? s.mascota.nombre : '-'}">Mascota</div>

                        <div class="small text-muted mt-2">Adoptante</div>
                        <div class="fw-semibold" th:text="${s.usuario != null ? s.usuario.nombre : '-'}">Adoptante</div>

                        <div class="small text-muted mt-2">Motivo</div>
                        <p class="mb-2" th:text="${s.pqAdoptar != null ? s.pqAdoptar : '-'}">Motivo</p>

                        <div class="d-flex gap-2 mt-auto" th:if="${s.estado != null and s.estado.id == 'PENDIENTE'}">
                            <button type="button"
                                    class="btn btn-sm lp-btn lp-btn-primary js-decidir"
                                    th:attr="data-id=${s.id},data-accion='APROBAR'">
                                <i class="bi bi-check-circle me-1"></i>Aprobar
                            </button>
                            <button type="button"
                                    class="btn btn-sm lp-btn lp-btn-danger js-decidir"
                                    th:attr="data-id=${s.id},data-accion='RECHAZAR'">
                                <i class="bi bi-x-circle me-1"></i>Rechazar
                            </button>
                        </div>
                    </div>
                </article>
            </div>

            <div class="col-12" th:if="${#lists.isEmpty(solicitudes)}">
                <div class="alert alert-info mb-0">No hay solicitudes registradas.</div>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    const token = document.querySelector('meta[name="_csrf"]')?.content;
    const headerName = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

    const estadoClasses = {
        PENDIENTE: { card: 'estado-pendiente', badge: 'text-bg-warning' },
        APROBADA: { card: 'estado-aprobada', badge: 'text-bg-success' },
        RECHAZADA: { card: 'estado-rechazada', badge: 'text-bg-danger' }
    };

    async function enviarDecision(id, accion, motivo) {
        const params = new URLSearchParams();
        params.append('accion', accion);
        if (motivo) params.append('motivo', motivo);

        const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
        if (token) headers[headerName] = token;

        const resp = await fetch(`/adopcion/gestor/solicitudes/${id}/decision`, {
            method: 'POST',
            headers,
            body: params.toString()
        });

        return resp.json();
    }

    function pintarEstado(card, nuevoEstado) {
        card.dataset.estado = nuevoEstado;
        card.classList.remove('estado-pendiente', 'estado-aprobada', 'estado-rechazada');

        const badge = card.querySelector('.estado-badge');
        badge.classList.remove('text-bg-warning', 'text-bg-success', 'text-bg-danger');

        const cfg = estadoClasses[nuevoEstado] || estadoClasses.RECHAZADA;
        card.classList.add(cfg.card);
        badge.classList.add(cfg.badge);
        badge.textContent = nuevoEstado;

        const actionBlock = card.querySelector('.js-decidir')?.closest('.d-flex');
        if (actionBlock) actionBlock.remove();
    }

    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.js-decidir');
        if (!btn) return;

        const solicitudId = btn.dataset.id;
        const accion = btn.dataset.accion;

        let motivo = 'No cumple criterios de adopción';
        if (accion === 'RECHAZAR') {
            const { value: text, isConfirmed } = await Swal.fire({
                title: 'Rechazar solicitud',
                input: 'textarea',
                inputLabel: 'Motivo de rechazo',
                inputValue: motivo,
                showCancelButton: true,
                confirmButtonText: 'Sí, rechazar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => !value?.trim() ? 'El motivo es obligatorio' : undefined
            });
            if (!isConfirmed) return;
            motivo = text.trim();
        } else {
            const { isConfirmed } = await Swal.fire({
                icon: 'question',
                title: '¿Aprobar solicitud?',
                text: 'Se creará la adopción y la mascota quedará ADOPTADA.',
                showCancelButton: true,
                confirmButtonText: 'Sí, aprobar',
                cancelButtonText: 'Cancelar'
            });
            if (!isConfirmed) return;
            motivo = '';
        }

        try {
            const data = await enviarDecision(solicitudId, accion, motivo);
            if (!data.ok) {
                await Swal.fire({ icon: 'error', title: 'No se pudo actualizar', text: data.mensaje || 'Error inesperado' });
                return;
            }

            const card = document.querySelector(`.solicitud-card[data-id="${solicitudId}"]`);
            if (card) pintarEstado(card, data.estado);

            await Swal.fire({
                icon: accion === 'APROBAR' ? 'success' : 'info',
                title: accion === 'APROBAR' ? 'Solicitud aprobada' : 'Solicitud rechazada',
                text: data.mensaje || 'Operación realizada correctamente'
            });
        } catch (err) {
            await Swal.fire({ icon: 'error', title: 'Error de red', text: 'No se pudo completar la operación.' });
        }
    });
})();
</script>
</body>
</html>
